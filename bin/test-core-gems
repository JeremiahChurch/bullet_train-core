#!/usr/bin/env bash

packages=(
  "bullet_train"
  "bullet_train-api"
  "bullet_train-fields"
  "bullet_train-has_uuid"
  "bullet_train-incoming_webhooks"
  "bullet_train-integrations"
  "bullet_train-integrations-stripe"
  "bullet_train-obfuscates_id"
  "bullet_train-outgoing_webhooks"
  "bullet_train-roles"
  "bullet_train-scope_questions"
  "bullet_train-scope_validator"
  "bullet_train-sortable"
  "bullet_train-super_load_and_authorize_resource"
  "bullet_train-super_scaffolding"
  "bullet_train-themes"
  "bullet_train-themes-light"
  "bullet_train-themes-tailwind_css"
)

for ((i = 0; i < ${#packages[@]}; ++i)); do
  if [ -z "${CIRCLE_NODE_INDEX}" ] || [ "${CIRCLE_NODE_INDEX}" == "${i}" ]; then

    # Run tests for two gems per node.
    FIRST_TEST_INDEX=($i * 2)
    echo "#####################################################################"
    echo ""
    echo "Running tests for ${packages[$FIRST_TEST_INDEX]}"
    echo ""
    echo "#####################################################################"
    bundle exec rails test local/bullet_train-core/${packages[$FIRST_TEST_INDEX]}

    if [ $? == "1" ]; then
      echo "Tests failed, exiting."
      exit 1
    fi

    if [ -z ${packages[($FIRST_TEST_INDEX + 1)]} ]; then
      echo "No more unit tests to run."
    else
      echo "#####################################################################"
      echo ""
      echo "Running tests for ${packages[($FIRST_TEST_INDEX + 1)]}"
      echo ""
      echo "#####################################################################"
      bundle exec rails test local/bullet_train-core/${packages[($FIRST_TEST_INDEX + 1)]}

      if [ $? == "1" ]; then
        echo "Tests failed, exiting."
        exit 1
      fi
    fi
  fi
done
