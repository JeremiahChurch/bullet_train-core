name: "Release Ruby Gems & NPM Packages"

on:
  workflow_dispatch:
    inputs:
      versionBump:
        description: 'Version Bump'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
    - uses: "actions/checkout@v3"

    - uses: "ruby/setup-ruby@v1"
      with:
        bundler-cache: true
        ruby-version: 3.2

    - uses: "actions/setup-node@v3"
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'

    - name: "echo pwd"
      run: pwd

    - name: "echo ls -al"
      run: ls -al

    - name: "echo versions"
      run: cat */lib/*/version.rb | grep VERSION

    - name: "echo versions"
      run: cat */lib/*/*/version.rb | grep VERSION

    - name: "echo npm versions"
      run: cat */package.json | grep version

    - name: "Install bump"
      run: gem install bump

    - name: "Bump all"
      run: ./bin/bump-all ${{ inputs.versionBump }}

    - name: "Setup ruby gems credentials file"
      run: |
        mkdir -p $HOME/.gem
        touch $HOME/.gem/credentials
        chmod 0600 $HOME/.gem/credentials
        printf -- "---\n:rubygems_api_key: ${GEM_HOST_API_KEY}\n" > $HOME/.gem/credentials

    - name: "Test rubygems api key"
      run: gem signin
      env:
        # Make sure to update the secret name
        # if yours isn't named RUBYGEMS_AUTH_TOKEN
        GEM_HOST_API_KEY: "${{secrets.RUBYGEMS_AUTH_TOKEN}}"

    # TODO: Do we need something like this?
    # Will we need to do it in each subdirectory?
    #- name: "Setup npm credentials file"
      #run: |
        #mkdir -p .npmrc
        #printf -- "//registry.npmjs.org/:${NPM_TOKEN}\n" > .npmrc

    - name: "Test npm api key"
      run: npm whoami
      env:
        # Make sure to update the secret name
        # if yours isn't named RUBYGEMS_AUTH_TOKEN
        NPM_TOKEN: "${{secrets.NPM_AUTH_TOKEN}}"

    - name: "Release all"
      run: ./bin/release-all

    - name: "echo versions"
      run: cat */lib/*/version.rb | grep VERSION

    - name: "echo versions"
      run: cat */lib/*/*/version.rb | grep VERSION

    - name: "echo npm versions"
      run: cat */package.json | grep version

